<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Registro | PangolesGames</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- IMPORTAR FIREBASE PRIMEIRO -->
  <script type="module" src="firebase.js"></script>
</head>

<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">PangolesGames</a>
  </div>
</nav>

<main class="container py-5">

  <h1 class="text-center mb-4">Criar conta</h1>

  <form id="form-registro" class="mx-auto" style="max-width:420px">
    <div class="mb-3">
      <label class="form-label">Nome</label>
      <input id="nome" type="text" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Email</label>
      <input id="email" type="email" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Senha</label>
      <input id="senha" type="password" minlength="4" class="form-control" required>
    </div>

    <button class="btn btn-primary w-100" type="submit">Criar conta</button>
  </form>

</main>

<!-- SCRIPT DO REGISTRO -->
<script type="module">

import { createUserWithEmailAndPassword } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { doc, setDoc } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase carregado no window
const auth = window.auth;
const db   = window.db;

document.getElementById("form-registro").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const nome = document.getElementById("nome").value.trim();
  const email = document.getElementById("email").value.trim().toLowerCase();
  const senha = document.getElementById("senha").value;

  /* =====================================================
     ðŸ”¥ 1. SALVAR NO LOCALSTORAGE (SEU SISTEMA ORIGINAL)
     ===================================================== */
  let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
  if (usuarios.find(u => u.email === email)) {
    alert("JÃ¡ existe uma conta com esse email.");
    return;
  }

  const novo = { nome, email, senha, role:"cliente" };
  usuarios.push(novo);

  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  localStorage.setItem("currentUser", JSON.stringify(novo));

  /* =====================================================
     ðŸ”¥ 2. SALVAR NO FIREBASE AUTH + FIRESTORE
     ===================================================== */
  try {
    // Cria no Authentication
    const cred = await createUserWithEmailAndPassword(auth, email, senha);
    const uid = cred.user.uid;

    // Salva no Firestore
    await setDoc(doc(db, "users", uid), {
      uid,
      nome,
      email,
      role: "cliente",
      criado_em: new Date().toISOString()
    });

    console.log("ðŸ”¥ Documento salvo no Firestore!");

  } catch (err) {
    console.error(err);
    alert("Erro ao salvar no Firebase: " + err.message);
  }

  /* =====================================================
     ðŸ”¥ 3. REDIRECIONA COMO SEMPRE
     ===================================================== */
  window.location.href = "meus-pedidos.html";
});
</script>

</body>
</html>
