<!DOCTYPE html>
<html lang="pt-br">
<head>
  <script type="module" src="firebase.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout | PangolesGames</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="index.html">
      <img src="IMG/banner.png" height="120" class="me-2" style="border-radius:120px;">
      PangolesGames
    </a>
  </div>
</nav>

<main class="container py-5">

  <h1 class="text-center fw-bold mb-4">Finalizar Compra</h1>

  <div id="itens"></div>

  <form id="form-checkout" class="mx-auto" style="max-width:700px">

    <h5>EndereÃ§o de entrega</h5>

    <div class="mb-3">
      <label class="form-label">EndereÃ§o completo</label>
      <input id="endereco" class="form-control" required>
    </div>

    <h5 class="mt-4">Pagamento</h5>
    <select id="pagamento" class="form-select mb-3" required>
      <option value="">Selecione</option>
      <option value="cartao">CartÃ£o</option>
      <option value="pix">PIX</option>
      <option value="boleto">Boleto</option>
    </select>

    <div id="pag-extra" class="mb-3"></div>

    <div class="d-grid mt-3">
      <button class="btn btn-success w-100" type="submit">Finalizar Pedido</button>
    </div>

  </form>

</main>

<footer class="bg-dark text-white text-center py-3 mt-4">Â© 2025 PangolesGames</footer>

<script>

// ðŸ”¥ðŸ”¥ðŸ”¥ 1. BLOQUEAR ACESSO SE NÃƒO ESTIVER LOGADO ðŸ”¥ðŸ”¥ðŸ”¥
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) {
  alert("VocÃª precisa estar logado para finalizar sua compra.");
  window.location.href = "login.html";
}

// ðŸ”¥ðŸ”¥ðŸ”¥ 2. BLOQUEAR ACESSO SE NÃƒO VEIO DO CARRINHO ðŸ”¥ðŸ”¥ðŸ”¥
const items = JSON.parse(localStorage.getItem('checkoutItems')) || [];
if (!items.length) {
  alert("Seu checkout estÃ¡ vazio. Adicione itens ao carrinho primeiro.");
  window.location.href = "carrinho.html";
}

// ---------------- ITENS NO CHECKOUT ----------------
function brl(n) {
  return n.toLocaleString('pt-BR',{ minimumFractionDigits:2 });
}

const frete = 30;
const itensBox = document.getElementById("itens");

let subtotal = 0;
let html = `<div class="card p-3 mb-4"><h5>Itens</h5><ul>`;

items.forEach(i => {
  subtotal += i.preco * i.quantidade;
  html += `<li>${i.nome} x${i.quantidade} â€” R$ ${brl(i.preco * i.quantidade)}</li>`;
});

html += `</ul>
         <p><strong>Subtotal:</strong> R$ ${brl(subtotal)}</p>
         <p><strong>Frete:</strong> R$ ${brl(frete)}</p>
         <h5>Total: R$ ${brl(subtotal + frete)}</h5>
         </div>`;

itensBox.innerHTML = html;

// ---------------- CAMPOS EXTRA ----------------
document.getElementById("pagamento").addEventListener("change", e => {
  const box = document.getElementById("pag-extra");

  if (e.target.value === "cartao") {
    box.innerHTML = `
      <input class="form-control mb-2" placeholder="Nome no cartÃ£o">
      <input class="form-control mb-2" placeholder="NÃºmero do cartÃ£o">
    `;
  } else if (e.target.value === "pix") {
    box.innerHTML = `<p>Use o PIX: <strong>pix@pangolesgames.com</strong></p>`;
  } else if (e.target.value === "boleto") {
    box.innerHTML = `<p>Um boleto fictÃ­cio serÃ¡ gerado.</p>`;
  } else {
    box.innerHTML = "";
  }
});

// ---------------- FINALIZAR PEDIDO ----------------
document.getElementById("form-checkout").addEventListener("submit", e => {
  e.preventDefault();

  const endereco = document.getElementById("endereco").value.trim();
  if (!endereco) return alert("Informe o endereÃ§o.");

  const metodo = document.getElementById("pagamento").value;
  if (!metodo) return alert("Escolha o mÃ©todo de pagamento.");

  const pedido = {
    id: Date.now(),
    email: currentUser.email,
    endereco,
    itens: items,
    metodoPagamento: metodo,
    frete,
    subtotal,
    total: subtotal + frete,
    data: new Date().toLocaleString(),
    status: "Pendente"
  };

  // salvar pedido
  let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
  pedidos.push(pedido);
  localStorage.setItem("pedidos", JSON.stringify(pedidos));

  // limpar carrinho
  localStorage.removeItem("carrinho");
  localStorage.removeItem("checkoutItems");

  alert("Pedido finalizado com sucesso!");
  window.location.href = "meus-pedidos.html";

});

</script>

</body>
</html>
